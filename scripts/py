#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${QTANNER_PYTHON:-}" ]]; then
  exec "$QTANNER_PYTHON" "$@"
fi

candidates=(
  /opt/homebrew/bin/python3
  /usr/local/bin/python3
  python3.14
  python3.13
  python3.12
  python3.11
  python3.10
  python3
)

seen=()

for cand in "${candidates[@]}"; do
  path="$cand"
  if [[ "$cand" == python3* ]]; then
    path="$(command -v "$cand" || true)"
  fi
  [[ -z "$path" ]] && continue
  [[ -x "$path" ]] || continue
  for used in "${seen[@]:-}"; do
    if [[ "$used" == "$path" ]]; then
      path=""
      break
    fi
  done
  [[ -z "$path" ]] && continue
  seen+=("$path")
  if "$path" -c "import sys; sys.exit(0 if hasattr(int,'bit_count') else 1)" >/dev/null 2>&1; then
    exec "$path" "$@"
  fi
done

echo "[qtanner] No suitable Python found (needs int.bit_count). Set QTANNER_PYTHON." >&2
exit 1
